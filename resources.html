<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umbrella ‚Äî Resource Recommender</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&family=Lora:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#f4f1eb;--bg2:#ffffff;--bg3:#edeae2;
      --navy:#1a2744;--navy2:#243358;
      --red:#c0392b;--red-dim:rgba(192,57,43,0.08);
      --orange:#d35400;--orange-dim:rgba(211,84,0,0.08);
      --green:#1e7e4a;--green-dim:rgba(30,126,74,0.08);
      --border:#ddd9ce;--border2:#c8c3b5;
      --text:#1a1a1a;--muted:#6b6456;--muted2:#8c8070;
      --serif:'Lora',Georgia,serif;
      --sans:'Instrument Sans',sans-serif;
      --mono:'IBM Plex Mono',monospace;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;}
    .navbar{background:var(--navy);padding:0 48px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;}
    .logo{display:flex;align-items:center;gap:12px;text-decoration:none;}
    .logo-mark{width:28px;height:28px;background:white;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .logo-text{font-size:15px;font-weight:700;color:white;letter-spacing:1px;}
    .logo-sub{font-size:10px;color:rgba(255,255,255,0.45);margin-top:1px;}
    .nav-links{display:flex;gap:4px;list-style:none;}
    .nav-links a{color:rgba(255,255,255,0.65);text-decoration:none;font-size:13px;padding:6px 14px;border-radius:3px;transition:all .15s;font-weight:500;}
    .nav-links a:hover{color:white;background:rgba(255,255,255,0.1);}
    .nav-links a.active{color:white;background:rgba(255,255,255,0.15);}

    .page-header{background:var(--navy);padding:40px 48px 36px;border-bottom:3px solid var(--red);display:flex;align-items:flex-end;justify-content:space-between;}
    .page-eyebrow{font-family:var(--mono);font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.35);margin-bottom:10px;}
    .page-title{font-family:var(--serif);font-size:36px;font-weight:600;color:white;margin-bottom:8px;}
    .page-desc{font-size:13px;color:rgba(255,255,255,0.5);}
    .status-badge{font-family:var(--mono);font-size:11px;padding:6px 14px;border-radius:2px;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);}
    .status-badge.live{border-color:rgba(74,222,128,0.4);color:#4ade80;background:rgba(74,222,128,0.08);}
    .status-badge.error{border-color:rgba(192,57,43,0.4);color:#f87171;background:rgba(192,57,43,0.08);}

    /* Situation strip */
    .sit-strip{display:grid;grid-template-columns:repeat(6,1fr);gap:1px;background:var(--border);border-bottom:1px solid var(--border);}
    .sit-cell{background:var(--bg2);padding:16px 20px 12px;position:relative;}
    .sit-cell::after{content:'';position:absolute;top:0;left:0;width:100%;height:3px;}
    .sit-cell.c-red::after{background:var(--red);}
    .sit-cell.c-orange::after{background:var(--orange);}
    .sit-cell.c-green::after{background:var(--green);}
    .sit-cell.c-navy::after{background:var(--navy);}
    .sit-cell.c-blue::after{background:#2563eb;}
    .sit-cell.c-gray::after{background:var(--muted2);}
    .sit-label{font-size:10px;font-weight:600;color:var(--muted2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px;}
    .sit-value{font-family:var(--mono);font-size:26px;font-weight:500;line-height:1;margin-bottom:2px;}
    .sit-sub{font-size:11px;color:var(--muted2);}

    .content{padding:28px 48px 48px;}

    /* Two col */
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}

    /* Section heading */
    .section-heading{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}

    /* Cards */
    .card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;overflow:hidden;}
    .card-header{padding:14px 20px;background:var(--bg3);border-bottom:1px solid var(--border);}
    .card-title{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;}
    .card-body{padding:4px 0;}

    /* Deployment items */
    .deploy-item{display:flex;align-items:flex-start;gap:14px;padding:14px 20px;border-bottom:1px solid var(--border);}
    .deploy-item:last-child{border-bottom:none;}
    .priority-tag{font-family:var(--mono);font-size:10px;font-weight:700;padding:3px 8px;border-radius:2px;letter-spacing:1px;flex-shrink:0;}
    .p1{background:var(--red-dim);color:var(--red);border:1px solid rgba(192,57,43,0.25);}
    .p2{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(211,84,0,0.25);}
    .p3{background:var(--green-dim);color:var(--green);border:1px solid rgba(30,126,74,0.2);}
    .deploy-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:3px;}
    .deploy-sub{font-size:11px;color:var(--muted2);font-family:var(--mono);}

    /* Evacuation list */
    .evac-row{display:flex;align-items:center;padding:12px 20px;border-bottom:1px solid var(--border);}
    .evac-row:last-child{border-bottom:none;}
    .evac-rank{font-family:var(--mono);font-size:16px;font-weight:500;color:var(--muted2);width:28px;flex-shrink:0;}
    .evac-info{flex:1;padding:0 14px;}
    .evac-name{font-size:13px;font-weight:600;color:var(--navy);margin-bottom:2px;}
    .evac-detail{font-size:11px;color:var(--muted2);}
    .evac-right{text-align:right;}
    .evac-score{font-family:var(--mono);font-size:20px;font-weight:500;}
    .evac-pop{font-size:11px;color:var(--muted2);font-family:var(--mono);}

    /* Alert generator */
    .lang-toggle{display:flex;gap:8px;margin-bottom:14px;}
    .lang-btn{padding:6px 16px;border-radius:3px;border:1px solid var(--border2);background:var(--bg3);color:var(--muted);font-family:var(--mono);font-size:11px;cursor:pointer;transition:all .15s;}
    .lang-btn.active{background:var(--navy);border-color:var(--navy);color:white;}

    .alert-box{background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:18px;font-family:var(--mono);font-size:12px;line-height:1.8;color:var(--text);white-space:pre-wrap;min-height:120px;margin-bottom:14px;}

    .action-btn{padding:9px 18px;border-radius:3px;border:none;font-family:var(--sans);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;margin-right:8px;}
    .btn-green{background:var(--green);color:white;}
    .btn-navy{background:var(--navy);color:white;}
    .btn-orange{background:var(--orange);color:white;}
    .action-btn:hover{opacity:.85;}

    /* Report */
    .report-card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:28px;margin-top:20px;}
    .report-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border);}
    .report-title{font-family:var(--serif);font-size:20px;font-weight:600;color:var(--navy);margin-bottom:4px;}
    .report-meta{font-family:var(--mono);font-size:10px;color:var(--muted2);}
    .report-section{margin-bottom:18px;}
    .report-section-title{font-size:10px;font-weight:600;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;}
    .report-line{font-size:13px;color:var(--muted);line-height:1.8;padding-left:14px;border-left:2px solid var(--border2);}

    .loading-text{text-align:center;color:var(--muted2);font-family:var(--mono);font-size:12px;padding:24px;}

    .fade-up{opacity:0;transform:translateY(8px);animation:fu .4s ease forwards;}
    @keyframes fu{to{opacity:1;transform:translateY(0);}}
    .d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}.d4{animation-delay:.2s}
  </style>
</head>
<body>

  <nav class="navbar">
    <a class="logo" href="index.html">
      <div class="logo-mark">‚òÇ</div>
      <div>
        <div class="logo-text">Umbrella</div>
        <div class="logo-sub">Disaster Intelligence ¬∑ Uttarakhand</div>
      </div>
    </a>
    <ul class="nav-links">
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="map.html">Risk Map</a></li>
      <li><a href="vulnerability.html">Vulnerability</a></li>
      <li><a href="resources.html" class="active">Resources</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
  </nav>

  <div class="page-header">
    <div>
      <div class="page-eyebrow">Live Intelligence ¬∑ Dynamic Recommendations</div>
      <div class="page-title">Resource Recommender</div>
      <div class="page-desc">NDRF deployment, evacuation priorities and alerts ‚Äî all driven by live data</div>
    </div>
    <span class="status-badge" id="status-badge">‚è≥ Loading...</span>
  </div>

  <!-- Situation Strip -->
  <div class="sit-strip fade-up d1">
    <div class="sit-cell c-red">
      <div class="sit-label">High Risk Villages</div>
      <div class="sit-value" id="sit-high" style="color:var(--red)">‚Äî</div>
      <div class="sit-sub">Score ‚â• 70</div>
    </div>
    <div class="sit-cell c-orange">
      <div class="sit-label">Medium Risk</div>
      <div class="sit-value" id="sit-medium" style="color:var(--orange)">‚Äî</div>
      <div class="sit-sub">Score 45‚Äì69</div>
    </div>
    <div class="sit-cell c-red">
      <div class="sit-label">People at Risk</div>
      <div class="sit-value" id="sit-pop" style="color:var(--red);font-size:18px;padding-top:4px">‚Äî</div>
      <div class="sit-sub">High risk villages</div>
    </div>
    <div class="sit-cell c-blue">
      <div class="sit-label">Peak Rainfall</div>
      <div class="sit-value" id="sit-rain" style="color:#2563eb">‚Äî</div>
      <div class="sit-sub" id="sit-rain-dist">48hr cumulative</div>
    </div>
    <div class="sit-cell c-orange">
      <div class="sit-label">Roads Blocked</div>
      <div class="sit-value" id="sit-roads" style="color:var(--orange)">‚Äî</div>
      <div class="sit-sub">Village access</div>
    </div>
    <div class="sit-cell c-gray">
      <div class="sit-label">Assessment Time</div>
      <div class="sit-value" id="sit-time" style="color:var(--muted);font-size:16px;padding-top:6px">‚Äî</div>
      <div class="sit-sub">IST</div>
    </div>
  </div>

  <div class="content">

    <!-- Deployment + Evacuation -->
    <div class="two-col fade-up d2">

      <div class="card">
        <div class="card-header">
          <div class="card-title">NDRF / SDRF Deployment Orders</div>
        </div>
        <div class="card-body" id="deployment-list">
          <div class="loading-text">Calculating deployment needs...</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Evacuation Priority List</div>
        </div>
        <div class="card-body" id="evacuation-list">
          <div class="loading-text">Ranking villages by urgency...</div>
        </div>
      </div>

    </div>

    <!-- Alert Generator -->
    <div class="card fade-up d3" style="margin-bottom:20px;">
      <div class="card-header">
        <div class="card-title">WhatsApp / SMS Alert ‚Äî Auto-generated from live data</div>
      </div>
      <div style="padding:20px;">
        <div class="lang-toggle">
          <button class="lang-btn active" onclick="switchLang('en',this)">English</button>
          <button class="lang-btn" onclick="switchLang('hi',this)">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
        </div>
        <div class="alert-box" id="alert-text">Generating alert from live data...</div>
        <button class="action-btn btn-green" onclick="copyAlert()">Copy Alert</button>
        <button class="action-btn btn-navy" onclick="generateAlert(currentLang)">Regenerate</button>
      </div>
    </div>

    <!-- Situation Report -->
    <div class="report-card fade-up d4">
      <div class="report-header">
        <div>
          <div class="report-title">Umbrella Situation Report</div>
          <div class="report-meta" id="report-meta">Generating...</div>
        </div>
        <button class="action-btn btn-orange" onclick="window.print()">Print / Download PDF</button>
      </div>
      <div id="report-body">
        <div class="loading-text">Building situation report from live data...</div>
      </div>
    </div>

  </div>

  <script>
    var BACKEND = "https://web-production-517aa.up.railway.app";
    var currentLang = 'en';
    var liveData = null;

    Promise.all([
      fetch(BACKEND + "/villages").then(function(r){return r.json();}),
      fetch(BACKEND + "/rainfall").then(function(r){return r.json();})
    ])
    .then(function(results){
      var villages  = results[0].villages;
      var districts = results[1].districts;

      var peakMm = 0, peakDist = '';
      districts.forEach(function(d){ if(d.mm_48hr>peakMm){peakMm=d.mm_48hr;peakDist=d.district;} });

      var high    = villages.filter(function(v){return v.risk_level==='HIGH';});
      var med     = villages.filter(function(v){return v.risk_level==='MEDIUM';});
      var blocked = villages.filter(function(v){return !v.road_safe;});
      var atRisk  = high.reduce(function(s,v){return s+v.population;},0);

      liveData = {villages:villages, highRisk:high, medRisk:med, roadsBlocked:blocked, atRiskPop:atRisk, peakMm:peakMm, peakDist:peakDist, districts:districts};

      var badge = document.getElementById('status-badge');
      badge.className = 'status-badge live';
      badge.innerText = 'üü¢ Live ‚Äî ' + new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});

      document.getElementById('sit-high').innerText   = high.length;
      document.getElementById('sit-medium').innerText = med.length;
      document.getElementById('sit-pop').innerText    = atRisk.toLocaleString();
      document.getElementById('sit-rain').innerText   = peakMm + 'mm';
      document.getElementById('sit-rain-dist').innerText = peakDist;
      document.getElementById('sit-roads').innerText  = blocked.length;
      document.getElementById('sit-time').innerText   = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:false});

      buildDeployment(liveData);
      buildEvacuation(liveData);
      generateAlert('en');
      buildReport(liveData);
    })
    .catch(function(){
      document.getElementById('status-badge').className = 'status-badge error';
      document.getElementById('status-badge').innerText = 'üî¥ Server Offline';
      ['deployment-list','evacuation-list','report-body'].forEach(function(id){
        document.getElementById(id).innerHTML = '<div class="loading-text" style="color:var(--red)">‚ö† Backend offline</div>';
      });
      document.getElementById('alert-text').innerText = '‚ö† Cannot generate alert ‚Äî backend offline';
    });

    function buildDeployment(d){
      var html = '';
      if(d.highRisk.length===0 && d.medRisk.length<=2){
        html += dItem('P3','Routine Monitoring Active','No immediate deployment required. SDRF teams on standby.');
      } else {
        if(d.highRisk.length>0){
          var names = d.highRisk.slice(0,3).map(function(v){return v.name;}).join(', ');
          html += dItem('P1','Deploy NDRF ‚Äî '+d.highRisk.length+' critical village'+(d.highRisk.length>1?'s':''),
            'Immediate deployment to: '+names+(d.highRisk.length>3?' + '+(d.highRisk.length-3)+' more':''));
        }
        if(d.roadsBlocked.length>0){
          html += dItem('P1','Helicopter Standby ‚Äî '+d.roadsBlocked.length+' village'+(d.roadsBlocked.length>1?'s':'')+' road-blocked',
            'Alert Gauchar / Dehradun airstrips. Aerial evacuation may be required.');
        }
        if(d.medRisk.length>0){
          html += dItem('P2','SDRF on Standby ‚Äî '+d.medRisk.length+' medium risk villages',
            'Pre-position at district HQ. Monitor rainfall every 3 hours.');
        }
        if(d.peakMm>=65){
          html += dItem('P2','Flood Warning ‚Äî '+d.peakDist+' ('+d.peakMm+'mm / 48hr)',
            'River levels rising. Alert downstream villages. CWC gauge check required.');
        }
        html += dItem('P3','Relief Camps ‚Äî Prepare for '+d.atRiskPop.toLocaleString()+' people',
          'Activate government schools and community halls in safe zones.');
      }
      document.getElementById('deployment-list').innerHTML = html;
    }

    function dItem(p, title, sub){
      return '<div class="deploy-item">' +
        '<span class="priority-tag '+p.toLowerCase()+'">'+p+'</span>' +
        '<div><div class="deploy-title">'+title+'</div><div class="deploy-sub">'+sub+'</div></div>' +
        '</div>';
    }

    function buildEvacuation(d){
      var sorted = d.villages.slice().sort(function(a,b){return b.score-a.score;});
      var html = '';
      sorted.slice(0,8).forEach(function(v,i){
        var c = v.score>=70?'var(--red)':v.score>=45?'var(--orange)':'var(--green)';
        var urgency = v.score>=70?(v.road_safe?'Evacuate by road now':'Aerial evacuation required'):
                     v.score>=45?'Prepare for evacuation':'Monitor ‚Äî low priority';
        html +=
          '<div class="evac-row">' +
            '<div class="evac-rank">'+(i+1)+'</div>' +
            '<div class="evac-info">' +
              '<div class="evac-name">'+v.name+'</div>' +
              '<div class="evac-detail">'+v.district+' ¬∑ '+urgency+'</div>' +
            '</div>' +
            '<div class="evac-right">' +
              '<div class="evac-score" style="color:'+c+'">'+v.score+'</div>' +
              '<div class="evac-pop">'+v.population.toLocaleString()+'</div>' +
            '</div>' +
          '</div>';
      });
      document.getElementById('evacuation-list').innerHTML = html;
    }

    function generateAlert(lang){
      currentLang = lang;
      if(!liveData){return;}
      var d = liveData;
      var now = new Date();
      var time = now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
      var date = now.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
      var alert = '';

      if(lang==='en'){
        alert = 'üö® UMBRELLA DISASTER ALERT\n'+date+' | '+time+' IST\n\n';
        if(d.highRisk.length>0){
          alert += '‚ö† HIGH RISK: '+d.highRisk.length+' village(s) at critical risk\n';
          d.highRisk.slice(0,3).forEach(function(v){ alert += '  ‚Ä¢ '+v.name+' ('+v.district+') ‚Äî Score: '+v.score+'\n'; });
        }
        alert += '\nüì° Peak Rainfall: '+d.peakMm+'mm in '+d.peakDist+' (48hr)\n';
        alert += 'üöß Roads Blocked: '+d.roadsBlocked.length+' village(s)\n';
        alert += 'üë• Population at Risk: '+d.atRiskPop.toLocaleString()+'\n\n';
        if(d.highRisk.length>0) alert += 'üî¥ IMMEDIATE ACTION REQUIRED\nNDRF deployment initiated. Avoid all river crossings.\n';
        else if(d.medRisk.length>2) alert += 'üü† ELEVATED ALERT ‚Äî SDRF on standby\nMonitor conditions. Avoid hill travel after dark.\n';
        else alert += 'üü¢ CONDITIONS NORMAL ‚Äî Monitoring active\n';
        alert += '\nSource: Umbrella Early Warning System\numbrella-dashboard.netlify.app';
      } else {
        alert = 'üö® ‡§Ö‡§Æ‡•ç‡§¨‡•ç‡§∞‡•á‡§≤‡§æ ‡§Ü‡§™‡§¶‡§æ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä\n'+date+' | '+time+' IST\n\n';
        if(d.highRisk.length>0){
          alert += '‚ö† ‡§â‡§ö‡•ç‡§ö ‡§ú‡•ã‡§ñ‡§ø‡§Æ: '+d.highRisk.length+' ‡§ó‡§æ‡§Ç‡§µ(‡•ã‡§Ç) ‡§Æ‡•á‡§Ç ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§ñ‡§§‡§∞‡§æ\n';
          d.highRisk.slice(0,3).forEach(function(v){ alert += '  ‚Ä¢ '+v.name+' ('+v.district+') ‚Äî ‡§∏‡•ç‡§ï‡•ã‡§∞: '+v.score+'\n'; });
        }
        alert += '\nüì° ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§µ‡§∞‡•ç‡§∑‡§æ: '+d.peakMm+'‡§Æ‡§ø‡§Æ‡•Ä ‚Äî '+d.peakDist+' (48 ‡§ò‡§Ç‡§ü‡•á)\n';
        alert += 'üöß ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß ‡§∏‡§°‡§º‡§ï‡•á‡§Ç: '+d.roadsBlocked.length+' ‡§ó‡§æ‡§Ç‡§µ\n';
        alert += 'üë• ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§Æ‡•á‡§Ç ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: '+d.atRiskPop.toLocaleString()+'\n\n';
        if(d.highRisk.length>0) alert += 'üî¥ ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï\nNDRF ‡§§‡•à‡§®‡§æ‡§§‡•§ ‡§∏‡§≠‡•Ä ‡§®‡§¶‡•Ä ‡§™‡§æ‡§∞‡§ó‡§Æ‡§® ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç‡•§\n';
        else if(d.medRisk.length>2) alert += 'üü† ‡§∏‡§§‡§∞‡•ç‡§ï‡§§‡§æ ‚Äî SDRF ‡§§‡•à‡§Ø‡§æ‡§∞\n';
        else alert += 'üü¢ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‚Äî ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ú‡§æ‡§∞‡•Ä\n';
        alert += '\n‡§∏‡•ç‡§∞‡•ã‡§§: ‡§Ö‡§Æ‡•ç‡§¨‡•ç‡§∞‡•á‡§≤‡§æ ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä\numbrella-dashboard.netlify.app';
      }
      document.getElementById('alert-text').innerText = alert;
    }

    function switchLang(lang, btn){
      document.querySelectorAll('.lang-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      generateAlert(lang);
    }

    function copyAlert(){
      navigator.clipboard.writeText(document.getElementById('alert-text').innerText).then(function(){
        var btn = event.target; btn.innerText = '‚úì Copied!';
        setTimeout(function(){btn.innerText='Copy Alert';},2000);
      });
    }

    function buildReport(d){
      var now  = new Date();
      var time = now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
      var date = now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
      document.getElementById('report-meta').innerText = 'Generated: '+date+' at '+time+' IST  |  Umbrella Early Warning System';

      var status = d.highRisk.length>0?'CRITICAL':d.medRisk.length>2?'ELEVATED':'NORMAL';
      var html = '';

      html += rSection('1. Situation Overview',
        'As of '+time+' IST on '+date+', assessment of '+d.villages.length+' villages across 6 districts shows overall '+status+' threat level. '+
        d.highRisk.length+' village(s) at HIGH risk, '+d.medRisk.length+' at MEDIUM risk. '+
        'Combined at-risk population: '+d.atRiskPop.toLocaleString()+'. Peak 48-hour rainfall: '+d.peakMm+'mm in '+d.peakDist+'.');

      if(d.highRisk.length>0){
        html += rSection('2. High Risk Villages ‚Äî Immediate Action Required',
          d.highRisk.map(function(v){
            return v.name+' ('+v.district+') ‚Äî Score: '+v.score+', Population: '+v.population.toLocaleString()+', Road: '+(v.road_safe?'Open':'BLOCKED');
          }).join('\n'));
      }

      html += rSection('3. District Rainfall Status',
        d.districts.map(function(d){return d.district+': '+d.mm_48hr+'mm (48hr) ‚Äî '+d.risk;}).join('\n'));

      var rec = '';
      if(d.highRisk.length>0) rec += '‚Ä¢ Deploy NDRF to '+d.highRisk.map(function(v){return v.name;}).join(', ')+'\n';
      if(d.roadsBlocked.length>0) rec += '‚Ä¢ '+d.roadsBlocked.length+' village(s) road-blocked ‚Äî arrange helicopter support\n';
      rec += '‚Ä¢ Pre-position relief for '+d.atRiskPop.toLocaleString()+' people\n';
      rec += '‚Ä¢ Activate emergency control rooms in affected districts\n';
      rec += '‚Ä¢ Issue public advisories ‚Äî avoid river crossings and hill travel\n';
      rec += '‚Ä¢ Monitor rainfall every 3 hours during active weather';
      html += rSection('4. Recommended Actions', rec);

      html += rSection('5. Data Sources',
        'Rainfall: Open-Meteo API (real-time) ¬∑ Village Data: Umbrella SQLite Database\n'+
        'Scoring: NDMA Risk Framework ‚Äî Hazard (50%) + Vulnerability (30%) + Exposure (20%)\n'+
        'System: umbrella-dashboard.netlify.app');

      document.getElementById('report-body').innerHTML = html;
    }

    function rSection(title, content){
      return '<div class="report-section"><div class="report-section-title">'+title+'</div>' +
        '<div class="report-line">'+content.replace(/\n/g,'<br>')+'</div></div>';
    }
  </script>

</body>
</html>
