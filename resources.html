<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umbrella ‚Äî Resource Recommender</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:      #060d1a;
      --bg2:     #0b1628;
      --bg3:     #0f1e35;
      --border:  rgba(56,189,248,0.12);
      --border2: rgba(56,189,248,0.25);
      --blue:    #38bdf8;
      --blue-dim:rgba(56,189,248,0.08);
      --red:     #f43f5e;
      --orange:  #fb923c;
      --green:   #34d399;
      --yellow:  #fbbf24;
      --text:    #f1f5f9;
      --muted:   #64748b;
      --muted2:  #94a3b8;
      --mono:    'Space Mono', monospace;
      --sans:    'DM Sans', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 50% at 20% 20%, rgba(56,189,248,0.04) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 80%, rgba(244,63,94,0.03) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
      mask-image: radial-gradient(ellipse at center, black 0%, transparent 75%);
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: rgba(6,13,26,0.85);
      backdrop-filter: blur(12px);
      padding: 0 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      height: 60px;
    }

    .logo {
      font-family: var(--mono);
      font-size: 18px;
      font-weight: 700;
      color: var(--blue);
      letter-spacing: 3px;
    }

    .logo span { color: var(--muted); font-weight: 400; }

    .nav-links { display: flex; gap: 8px; list-style: none; }

    .nav-links a {
      color: var(--muted2);
      text-decoration: none;
      font-size: 12px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      font-family: var(--mono);
      padding: 6px 12px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .nav-links a:hover, .nav-links a.active {
      color: var(--blue);
      background-color: var(--blue-dim);
    }

    .content {
      position: relative;
      z-index: 1;
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Page header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 40px;
    }

    .page-title {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--blue);
      margin-bottom: 8px;
    }

    .page-heading {
      font-family: var(--mono);
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: 2px;
      margin-bottom: 4px;
    }

    .page-sub {
      font-size: 13px;
      color: var(--muted2);
      font-weight: 300;
    }

    .status-badge {
      font-family: var(--mono);
      font-size: 11px;
      padding: 6px 14px;
      border-radius: 2px;
      border: 1px solid;
      letter-spacing: 1px;
    }

    .status-badge.loading { color: var(--orange); border-color: rgba(251,146,60,0.3); background: rgba(251,146,60,0.05); }
    .status-badge.live    { color: var(--green);  border-color: rgba(52,211,153,0.3);  background: rgba(52,211,153,0.05); }
    .status-badge.error   { color: var(--red);    border-color: rgba(244,63,94,0.3);   background: rgba(244,63,94,0.05); }

    /* Situation Summary */
    .situation-bar {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 20px 28px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 40px;
      position: relative;
      overflow: hidden;
    }

    .situation-bar::before {
      content: '';
      position: absolute;
      left: 0; top: 0;
      width: 3px; height: 100%;
    }

    .situation-bar.critical::before { background: var(--red); }
    .situation-bar.elevated::before { background: var(--orange); }
    .situation-bar.normal::before   { background: var(--green); }

    .sit-item { text-align: center; }

    .sit-value {
      font-family: var(--mono);
      font-size: 32px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }

    .sit-label {
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .sit-divider {
      width: 1px;
      height: 40px;
      background: var(--border2);
    }

    /* Section title */
    .section-title {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--blue);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, var(--border2), transparent);
    }

    /* Grid layouts */
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }
    .three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 32px; }

    /* Cards */
    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 24px;
    }

    .card-title {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted2);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    /* Deployment recommendations */
    .deploy-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }

    .deploy-item:last-child { border-bottom: none; }

    .deploy-priority {
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 1px;
      letter-spacing: 1px;
      flex-shrink: 0;
    }

    .p1 { background: rgba(244,63,94,0.15);  color: var(--red);    border: 1px solid rgba(244,63,94,0.3); }
    .p2 { background: rgba(251,146,60,0.15); color: var(--orange); border: 1px solid rgba(251,146,60,0.3); }
    .p3 { background: rgba(52,211,153,0.1);  color: var(--green);  border: 1px solid rgba(52,211,153,0.2); }

    .deploy-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
    }

    .deploy-sub {
      font-size: 11px;
      color: var(--muted2);
      margin-top: 3px;
      font-family: var(--mono);
    }

    /* Evacuation list */
    .evac-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .evac-row:last-child { border-bottom: none; }

    .evac-rank {
      font-family: var(--mono);
      font-size: 18px;
      font-weight: 700;
      color: var(--muted);
      width: 32px;
      flex-shrink: 0;
    }

    .evac-info { flex: 1; padding: 0 16px; }

    .evac-name {
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
    }

    .evac-detail {
      font-size: 11px;
      color: var(--muted2);
    }

    .evac-score {
      font-family: var(--mono);
      font-size: 20px;
      font-weight: 700;
      text-align: right;
    }

    .evac-pop {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      text-align: right;
    }

    /* WhatsApp alert */
    .alert-box {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 20px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.8;
      color: var(--text);
      white-space: pre-wrap;
      margin-bottom: 16px;
      min-height: 120px;
    }

    .lang-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .lang-btn {
      padding: 6px 16px;
      border-radius: 2px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--muted2);
      font-family: var(--mono);
      font-size: 11px;
      cursor: pointer;
      letter-spacing: 1px;
    }

    .lang-btn.active {
      background: var(--blue-dim);
      border-color: var(--blue);
      color: var(--blue);
    }

    .action-btn {
      padding: 10px 20px;
      border-radius: 2px;
      border: none;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-right: 8px;
      transition: all 0.2s;
    }

    .btn-green  { background: var(--green);  color: var(--bg); }
    .btn-blue   { background: var(--blue);   color: var(--bg); }
    .btn-orange { background: var(--orange); color: var(--bg); }

    .action-btn:hover { opacity: 0.85; transform: translateY(-1px); }

    /* Situation report */
    .report-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 32px;
      margin-bottom: 32px;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .report-title {
      font-family: var(--mono);
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: 2px;
      margin-bottom: 4px;
    }

    .report-meta {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    .report-section {
      margin-bottom: 20px;
    }

    .report-section-title {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--blue);
      margin-bottom: 10px;
    }

    .report-line {
      font-size: 13px;
      color: var(--muted2);
      line-height: 1.8;
      padding-left: 16px;
      border-left: 2px solid var(--border2);
    }

    /* Loading state */
    .loading-text {
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      font-style: italic;
      padding: 20px 0;
      text-align: center;
    }

    .fade-in {
      opacity: 0;
      transform: translateY(12px);
      animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .d1 { animation-delay: 0.1s; }
    .d2 { animation-delay: 0.2s; }
    .d3 { animation-delay: 0.3s; }
    .d4 { animation-delay: 0.4s; }
  </style>
</head>

<body>

  <nav class="navbar">
    <div class="logo">‚òÇ <span>//</span> UMBRELLA</div>
    <ul class="nav-links">
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="map.html">Risk Map</a></li>
      <li><a href="vulnerability.html">Vulnerability</a></li>
      <li><a href="resources.html" class="active">Resources</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
  </nav>

  <div class="content">

    <!-- Page Header -->
    <div class="page-header fade-in">
      <div>
        <div class="page-title">‚ö° Live Intelligence</div>
        <div class="page-heading">RESOURCE RECOMMENDER</div>
        <div class="page-sub">
          Dynamic recommendations based on live village scores and rainfall data
        </div>
      </div>
      <span class="status-badge loading" id="status-badge">
        ‚è≥ Loading live data...
      </span>
    </div>

    <!-- Situation Summary Bar -->
    <div class="situation-bar normal fade-in d1" id="situation-bar">
      <div class="sit-item">
        <div class="sit-value" id="sit-high" style="color:var(--red)">‚Äî</div>
        <div class="sit-label">High Risk Villages</div>
      </div>
      <div class="sit-divider"></div>
      <div class="sit-item">
        <div class="sit-value" id="sit-medium" style="color:var(--orange)">‚Äî</div>
        <div class="sit-label">Medium Risk</div>
      </div>
      <div class="sit-divider"></div>
      <div class="sit-item">
        <div class="sit-value" id="sit-pop" style="color:var(--red)">‚Äî</div>
        <div class="sit-label">People at Risk</div>
      </div>
      <div class="sit-divider"></div>
      <div class="sit-item">
        <div class="sit-value" id="sit-rainfall" style="color:var(--blue)">‚Äî</div>
        <div class="sit-label">Peak 48hr Rainfall</div>
      </div>
      <div class="sit-divider"></div>
      <div class="sit-item">
        <div class="sit-value" id="sit-roads" style="color:var(--orange)">‚Äî</div>
        <div class="sit-label">Roads Blocked</div>
      </div>
      <div class="sit-divider"></div>
      <div class="sit-item">
        <div class="sit-value" id="sit-time" style="color:var(--muted2);font-size:16px;padding-top:8px;">‚Äî</div>
        <div class="sit-label">Assessment Time</div>
      </div>
    </div>

    <!-- Deployment + Evacuation -->
    <div class="two-col fade-in d2">

      <!-- NDRF/SDRF Deployment -->
      <div class="card">
        <div class="card-title">ü™ñ NDRF / SDRF Deployment Orders</div>
        <div id="deployment-list">
          <div class="loading-text">Calculating deployment needs...</div>
        </div>
      </div>

      <!-- Evacuation Priority -->
      <div class="card">
        <div class="card-title">üö® Evacuation Priority List</div>
        <div id="evacuation-list">
          <div class="loading-text">Ranking villages by urgency...</div>
        </div>
      </div>

    </div>

    <!-- WhatsApp Alert Generator -->
    <div class="section-title fade-in d3">üì± Alert Generator</div>

    <div class="card fade-in d3" style="margin-bottom:32px;">
      <div class="card-title">WhatsApp / SMS Alert ‚Äî Auto-generated from live data</div>

      <div class="lang-toggle">
        <button class="lang-btn active" onclick="switchLang('en', this)">English</button>
        <button class="lang-btn" onclick="switchLang('hi', this)">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
      </div>

      <div class="alert-box" id="alert-text">
        Generating alert from live data...
      </div>

      <button class="action-btn btn-green" onclick="copyAlert()">
        üìã Copy Alert
      </button>
      <button class="action-btn btn-blue" onclick="generateAlert('en')">
        üîÑ Regenerate
      </button>
    </div>

    <!-- Situation Report -->
    <div class="section-title fade-in d4">üìÑ Situation Report</div>

    <div class="report-card fade-in d4" id="situation-report">
      <div class="report-header">
        <div>
          <div class="report-title">UMBRELLA SITUATION REPORT</div>
          <div class="report-meta" id="report-meta">
            Generating...
          </div>
        </div>
        <button class="action-btn btn-orange" onclick="printReport()">
          üñ® Download / Print
        </button>
      </div>
      <div id="report-body">
        <div class="loading-text">Building situation report from live data...</div>
      </div>
    </div>

  </div>


  <script>

    var BACKEND = "https://web-production-517aa.up.railway.app";
    var currentLang = 'en';
    var liveData = null;



    // FETCH ALL LIVE DATA


    Promise.all([
      fetch(BACKEND + "/villages").then(function(r) { return r.json(); }),
      fetch(BACKEND + "/rainfall").then(function(r) { return r.json(); })
    ])
    .then(function(results) {

      var villageData  = results[0];
      var rainfallData = results[1];

      var villages  = villageData.villages;
      var districts = rainfallData.districts;

      // Find peak rainfall
      var peakMm   = 0;
      var peakDist = '';
      districts.forEach(function(d) {
        if (d.mm_48hr > peakMm) {
          peakMm   = d.mm_48hr;
          peakDist = d.district;
        }
      });

      // Categorise villages
      var highRisk   = villages.filter(function(v) { return v.risk_level === 'HIGH'; });
      var medRisk    = villages.filter(function(v) { return v.risk_level === 'MEDIUM'; });
      var roadsBlocked = villages.filter(function(v) { return !v.road_safe; });
      var atRiskPop  = highRisk.reduce(function(sum, v) { return sum + v.population; }, 0);

      // Store globally for alert/report generation
      liveData = {
        villages:     villages,
        highRisk:     highRisk,
        medRisk:      medRisk,
        roadsBlocked: roadsBlocked,
        atRiskPop:    atRiskPop,
        peakMm:       peakMm,
        peakDist:     peakDist,
        districts:    districts
      };

      // Update status badge
      var badge = document.getElementById('status-badge');
      badge.className = 'status-badge live';
      badge.innerText = 'üü¢ Live Data ‚Äî ' + new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

      // Update situation bar
      var overallRisk = highRisk.length > 0 ? 'critical'
                      : medRisk.length > 3  ? 'elevated' : 'normal';
      document.getElementById('situation-bar').className =
        'situation-bar ' + overallRisk + ' fade-in d1';

      document.getElementById('sit-high').innerText     = highRisk.length;
      document.getElementById('sit-medium').innerText   = medRisk.length;
      document.getElementById('sit-pop').innerText      = atRiskPop.toLocaleString();
      document.getElementById('sit-rainfall').innerText = peakMm + 'mm';
      document.getElementById('sit-roads').innerText    = roadsBlocked.length;
      document.getElementById('sit-time').innerText     = new Date().toLocaleTimeString('en-IN', {
        hour: '2-digit', minute: '2-digit', hour12: false
      });

      // Build all sections
      buildDeployment(liveData);
      buildEvacuation(liveData);
      generateAlert('en');
      buildReport(liveData);

    })
    .catch(function() {
      var badge = document.getElementById('status-badge');
      badge.className = 'status-badge error';
      badge.innerText = 'üî¥ Server Offline';

      ['deployment-list','evacuation-list','alert-text','report-body'].forEach(function(id) {
        document.getElementById(id).innerHTML =
          '<div class="loading-text" style="color:var(--red)">‚ö† Backend offline ‚Äî cannot generate recommendations</div>';
      });
    });



    // DEPLOYMENT RECOMMENDATIONS


    function buildDeployment(d) {
      var html = '';

      if (d.highRisk.length === 0 && d.medRisk.length <= 2) {

        html += deployItem('P3', 'Routine Monitoring Active',
          'No immediate deployment required. SDRF teams on standby.');

      } else {

        if (d.highRisk.length > 0) {
          var names = d.highRisk.slice(0, 3).map(function(v) { return v.name; }).join(', ');
          html += deployItem('P1',
            'Deploy NDRF Team ‚Äî ' + d.highRisk.length + ' critical village' + (d.highRisk.length > 1 ? 's' : ''),
            'Immediate deployment to: ' + names +
            (d.highRisk.length > 3 ? ' + ' + (d.highRisk.length - 3) + ' more' : ''));
        }

        if (d.roadsBlocked.length > 0) {
          html += deployItem('P1',
            'Helicopter Standby ‚Äî ' + d.roadsBlocked.length + ' village' + (d.roadsBlocked.length > 1 ? 's' : '') + ' road-blocked',
            'Aerial evacuation may be required. Alert Gauchar/Dehradun airstrips.');
        }

        if (d.medRisk.length > 0) {
          html += deployItem('P2',
            'SDRF Teams on Standby ‚Äî ' + d.medRisk.length + ' medium risk villages',
            'Pre-position teams at district HQ. Monitor rainfall every 3 hours.');
        }

        if (d.peakMm >= 65) {
          html += deployItem('P2',
            'Flood Warning ‚Äî ' + d.peakDist + ' district (' + d.peakMm + 'mm / 48hr)',
            'River levels rising. Alert downstream villages. CWC gauge check required.');
        }

        html += deployItem('P3',
          'Relief Camps ‚Äî Prepare capacity for ' + d.atRiskPop.toLocaleString() + ' people',
          'Activate government schools and community halls in safe zones.');
      }

      document.getElementById('deployment-list').innerHTML = html;
    }

    function deployItem(priority, title, sub) {
      return '<div class="deploy-item">' +
        '<span class="deploy-priority ' + priority.toLowerCase() + '">' + priority + '</span>' +
        '<div>' +
          '<div class="deploy-text">' + title + '</div>' +
          '<div class="deploy-sub">' + sub + '</div>' +
        '</div>' +
      '</div>';
    }



    // EVACUATION PRIORITY LIST


    function buildEvacuation(d) {
      var sorted = d.villages.slice().sort(function(a, b) {
        return b.score - a.score;
      });

      var top = sorted.slice(0, 8);
      var html = '';

      top.forEach(function(v, i) {
        var color = v.score >= 70 ? 'var(--red)'
                  : v.score >= 45 ? 'var(--orange)'
                  : 'var(--green)';

        var urgency = v.score >= 70
          ? (v.road_safe ? 'Evacuate by road NOW' : 'Aerial evacuation required')
          : v.score >= 45 ? 'Prepare for evacuation'
          : 'Monitor ‚Äî low priority';

        html +=
          '<div class="evac-row">' +
            '<div class="evac-rank">' + (i + 1) + '</div>' +
            '<div class="evac-info">' +
              '<div class="evac-name">' + v.name + '</div>' +
              '<div class="evac-detail">' + v.district + ' ¬∑ ' + urgency + '</div>' +
            '</div>' +
            '<div>' +
              '<div class="evac-score" style="color:' + color + '">' + v.score + '</div>' +
              '<div class="evac-pop">' + v.population.toLocaleString() + ' people</div>' +
            '</div>' +
          '</div>';
      });

      document.getElementById('evacuation-list').innerHTML = html;
    }



    // ALERT GENERATOR


    function generateAlert(lang) {
      currentLang = lang;
      if (!liveData) return;

      var d    = liveData;
      var now  = new Date();
      var time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
      var date = now.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });

      var topVillage = d.highRisk.length > 0 ? d.highRisk[0] : (d.medRisk.length > 0 ? d.medRisk[0] : null);

      var alert = '';

      if (lang === 'en') {

        alert = 'üö® UMBRELLA DISASTER ALERT\n';
        alert += date + ' | ' + time + ' IST\n\n';

        if (d.highRisk.length > 0) {
          alert += '‚ö† HIGH RISK: ' + d.highRisk.length + ' village(s) at critical risk\n';
          d.highRisk.slice(0, 3).forEach(function(v) {
            alert += '  ‚Ä¢ ' + v.name + ' (' + v.district + ') ‚Äî Score: ' + v.score + '\n';
          });
        }

        alert += '\nüì° Peak Rainfall: ' + d.peakMm + 'mm in ' + d.peakDist + ' (48hr)\n';
        alert += 'üöß Roads Blocked: ' + d.roadsBlocked.length + ' village(s)\n';
        alert += 'üë• Population at Risk: ' + d.atRiskPop.toLocaleString() + '\n\n';

        if (d.highRisk.length > 0) {
          alert += 'üî¥ IMMEDIATE ACTION REQUIRED\n';
          alert += 'NDRF deployment initiated. Avoid all river crossings.\n';
        } else if (d.medRisk.length > 2) {
          alert += 'üü† ELEVATED ALERT ‚Äî SDRF on standby\n';
          alert += 'Monitor conditions. Avoid hill travel after dark.\n';
        } else {
          alert += 'üü¢ CONDITIONS NORMAL ‚Äî Monitoring active\n';
        }

        alert += '\nSource: Umbrella Early Warning System\numbrella-dashboard.netlify.app';

      } else {

        alert = 'üö® ‡§Ö‡§Æ‡•ç‡§¨‡•ç‡§∞‡•á‡§≤‡§æ ‡§Ü‡§™‡§¶‡§æ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä\n';
        alert += date + ' | ' + time + ' IST\n\n';

        if (d.highRisk.length > 0) {
          alert += '‚ö† ‡§â‡§ö‡•ç‡§ö ‡§ú‡•ã‡§ñ‡§ø‡§Æ: ' + d.highRisk.length + ' ‡§ó‡§æ‡§Ç‡§µ(‡•ã‡§Ç) ‡§Æ‡•á‡§Ç ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§ñ‡§§‡§∞‡§æ\n';
          d.highRisk.slice(0, 3).forEach(function(v) {
            alert += '  ‚Ä¢ ' + v.name + ' (' + v.district + ') ‚Äî ‡§∏‡•ç‡§ï‡•ã‡§∞: ' + v.score + '\n';
          });
        }

        alert += '\nüì° ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§µ‡§∞‡•ç‡§∑‡§æ: ' + d.peakMm + '‡§Æ‡§ø‡§Æ‡•Ä ‚Äî ' + d.peakDist + ' (48 ‡§ò‡§Ç‡§ü‡•á)\n';
        alert += 'üöß ‡§Ö‡§µ‡§∞‡•Å‡§¶‡•ç‡§ß ‡§∏‡§°‡§º‡§ï‡•á‡§Ç: ' + d.roadsBlocked.length + ' ‡§ó‡§æ‡§Ç‡§µ\n';
        alert += 'üë• ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§Æ‡•á‡§Ç ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: ' + d.atRiskPop.toLocaleString() + '\n\n';

        if (d.highRisk.length > 0) {
          alert += 'üî¥ ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï\n';
          alert += 'NDRF ‡§§‡•à‡§®‡§æ‡§§‡•§ ‡§∏‡§≠‡•Ä ‡§®‡§¶‡•Ä ‡§™‡§æ‡§∞‡§ó‡§Æ‡§® ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç‡•§\n';
        } else if (d.medRisk.length > 2) {
          alert += 'üü† ‡§∏‡§§‡§∞‡•ç‡§ï‡§§‡§æ ‚Äî SDRF ‡§§‡•à‡§Ø‡§æ‡§∞\n';
          alert += '‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•Ä ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§∞‡§æ‡§§ ‡§ï‡•ã ‡§™‡§π‡§æ‡§°‡§º‡•Ä ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§\n';
        } else {
          alert += 'üü¢ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‚Äî ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ú‡§æ‡§∞‡•Ä\n';
        }

        alert += '\n‡§∏‡•ç‡§∞‡•ã‡§§: ‡§Ö‡§Æ‡•ç‡§¨‡•ç‡§∞‡•á‡§≤‡§æ ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä\numbrella-dashboard.netlify.app';
      }

      document.getElementById('alert-text').innerText = alert;
    }

    function switchLang(lang, btn) {
      document.querySelectorAll('.lang-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      btn.classList.add('active');
      generateAlert(lang);
    }

    function copyAlert() {
      var text = document.getElementById('alert-text').innerText;
      navigator.clipboard.writeText(text).then(function() {
        var btn = event.target;
        btn.innerText = '‚úì Copied!';
        setTimeout(function() { btn.innerText = 'üìã Copy Alert'; }, 2000);
      });
    }



    // SITUATION REPORT


    function buildReport(d) {
      var now  = new Date();
      var time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
      var date = now.toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

      document.getElementById('report-meta').innerText =
        'Generated: ' + date + ' at ' + time + ' IST  |  Source: Umbrella Early Warning System';

      var overallStatus = d.highRisk.length > 0 ? 'CRITICAL'
                        : d.medRisk.length > 2  ? 'ELEVATED' : 'NORMAL';

      var html = '';

      // Section 1 ‚Äî Overview
      html += reportSection('1. SITUATION OVERVIEW',
        'As of ' + time + ' IST on ' + date + ', Umbrella\'s automated assessment of ' +
        d.villages.length + ' villages across 6 districts of Uttarakhand indicates an overall ' +
        overallStatus + ' threat level. ' +
        d.highRisk.length + ' village(s) are at HIGH risk, ' +
        d.medRisk.length + ' at MEDIUM risk, with a combined at-risk population of ' +
        d.atRiskPop.toLocaleString() + ' people. ' +
        'Peak 48-hour cumulative rainfall recorded: ' + d.peakMm + 'mm in ' + d.peakDist + ' district.'
      );

      // Section 2 ‚Äî High Risk Villages
      if (d.highRisk.length > 0) {
        var villageLines = d.highRisk.map(function(v) {
          return v.name + ' (' + v.district + ') ‚Äî Risk Score: ' + v.score +
            ', Population: ' + v.population.toLocaleString() +
            ', Road: ' + (v.road_safe ? 'Open' : 'BLOCKED') +
            ', GLOF travel time: ' + (v.travel_time === 999 ? 'N/A' : v.travel_time + ' min');
        }).join('\n');
        html += reportSection('2. HIGH RISK VILLAGES ‚Äî IMMEDIATE ACTION REQUIRED', villageLines);
      }

      // Section 3 ‚Äî Rainfall
      var rainfallLines = d.districts.map(function(dist) {
        return dist.district + ': ' + dist.mm_48hr + 'mm (48hr) ‚Äî ' + dist.risk;
      }).join('\n');
      html += reportSection('3. DISTRICT RAINFALL STATUS', rainfallLines);

      // Section 4 ‚Äî Recommendations
      var recLines = '';
      if (d.highRisk.length > 0) {
        recLines += '‚Ä¢ Deploy NDRF teams immediately to ' + d.highRisk.map(function(v) { return v.name; }).join(', ') + '\n';
      }
      if (d.roadsBlocked.length > 0) {
        recLines += '‚Ä¢ ' + d.roadsBlocked.length + ' village(s) with blocked roads ‚Äî arrange helicopter support\n';
      }
      recLines += '‚Ä¢ Pre-position relief supplies for ' + d.atRiskPop.toLocaleString() + ' people\n';
      recLines += '‚Ä¢ Activate emergency control rooms in ' + (d.highRisk.length > 0 ? 'all affected' : 'high-risk') + ' districts\n';
      recLines += '‚Ä¢ Issue public advisories ‚Äî avoid river crossings and hill travel\n';
      recLines += '‚Ä¢ Monitor Open-Meteo rainfall every 3 hours during active weather';

      html += reportSection('4. RECOMMENDED ACTIONS', recLines);

      // Section 5 ‚Äî Data sources
      html += reportSection('5. DATA SOURCES',
        'Rainfall: Open-Meteo API (real-time)\n' +
        'Village Data: Umbrella SQLite Database\n' +
        'Scoring: Weighted vulnerability formula (Population 25%, GLOF Travel Time 20%, Rainfall 20%, Road Safety 20%, Historical Events 15%)\n' +
        'System: Umbrella Early Warning Dashboard ‚Äî umbrella-dashboard.netlify.app'
      );

      document.getElementById('report-body').innerHTML = html;
    }

    function reportSection(title, content) {
      return '<div class="report-section">' +
        '<div class="report-section-title">' + title + '</div>' +
        '<div class="report-line">' +
          content.replace(/\n/g, '<br>') +
        '</div>' +
      '</div>';
    }

    function printReport() {
      window.print();
    }

  </script>

</body>
</html>