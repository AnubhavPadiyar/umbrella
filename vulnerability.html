<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umbrella ‚Äî Village Vulnerability Scorer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&family=Lora:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#f4f1eb;--bg2:#ffffff;--bg3:#edeae2;
      --navy:#1a2744;--navy2:#243358;
      --red:#c0392b;--red-dim:rgba(192,57,43,0.08);
      --orange:#d35400;--orange-dim:rgba(211,84,0,0.08);
      --green:#1e7e4a;--green-dim:rgba(30,126,74,0.08);
      --border:#ddd9ce;--border2:#c8c3b5;
      --text:#1a1a1a;--muted:#6b6456;--muted2:#8c8070;
      --serif:'Lora',Georgia,serif;
      --sans:'Instrument Sans',sans-serif;
      --mono:'IBM Plex Mono',monospace;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;}

    .navbar{background:var(--navy);padding:0 48px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;}
    .logo{display:flex;align-items:center;gap:12px;text-decoration:none;}
    .logo-mark{width:28px;height:28px;background:white;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .logo-text{font-size:15px;font-weight:700;color:white;letter-spacing:1px;}
    .logo-sub{font-size:10px;color:rgba(255,255,255,0.45);margin-top:1px;}
    .nav-links{display:flex;gap:4px;list-style:none;}
    .nav-links a{color:rgba(255,255,255,0.65);text-decoration:none;font-size:13px;padding:6px 14px;border-radius:3px;transition:all .15s;font-weight:500;}
    .nav-links a:hover{color:white;background:rgba(255,255,255,0.1);}
    .nav-links a.active{color:white;background:rgba(255,255,255,0.15);}

    .page-header{background:var(--navy);padding:40px 48px 36px;border-bottom:3px solid var(--red);display:flex;align-items:flex-end;justify-content:space-between;}
    .page-eyebrow{font-family:var(--mono);font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.35);margin-bottom:10px;}
    .page-title{font-family:var(--serif);font-size:36px;font-weight:600;color:white;margin-bottom:8px;}
    .page-desc{font-size:13px;color:rgba(255,255,255,0.5);}
    .status-badge{font-family:var(--mono);font-size:11px;padding:6px 14px;border-radius:2px;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);}
    .status-badge.live{border-color:rgba(74,222,128,0.4);color:#4ade80;background:rgba(74,222,128,0.08);}

    .stat-strip{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border-bottom:1px solid var(--border);}
    .stat-cell{background:var(--bg2);padding:18px 24px 14px;position:relative;}
    .stat-cell::after{content:'';position:absolute;top:0;left:0;width:100%;height:3px;}
    .stat-cell.s-red::after{background:var(--red);}
    .stat-cell.s-orange::after{background:var(--orange);}
    .stat-cell.s-green::after{background:var(--green);}
    .stat-cell.s-navy::after{background:var(--navy);}
    .stat-label{font-size:10px;font-weight:600;color:var(--muted2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;}
    .stat-value{font-family:var(--mono);font-size:30px;font-weight:500;line-height:1;margin-bottom:3px;}
    .stat-sub{font-size:11px;color:var(--muted2);}

    .content{padding:24px 48px 40px;}

    .filter-bar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
    .filter-label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-right:4px;}
    .filter-btn{padding:6px 14px;border-radius:3px;border:1px solid var(--border2);background:var(--bg2);color:var(--muted);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;font-family:var(--sans);}
    .filter-btn:hover{border-color:var(--navy);color:var(--navy);}
    .filter-btn.active-all{background:var(--navy);border-color:var(--navy);color:white;}
    .filter-btn.active-high{background:var(--red);border-color:var(--red);color:white;}
    .filter-btn.active-medium{background:var(--orange);border-color:var(--orange);color:white;}
    .filter-btn.active-low{background:var(--green);border-color:var(--green);color:white;}
    .filter-btn.active-both{background:var(--navy2);border-color:var(--navy2);color:white;}

    .table-card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;overflow:hidden;}
    .table-card-header{padding:14px 20px;border-bottom:1px solid var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:space-between;}
    .table-card-title{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;}

    .village-table{width:100%;border-collapse:collapse;font-size:13px;}
    .village-table th{text-align:left;font-size:10px;font-weight:600;color:var(--muted2);letter-spacing:.8px;text-transform:uppercase;padding:10px 16px;background:var(--bg3);border-bottom:1px solid var(--border);white-space:nowrap;}
    .village-table td{padding:13px 16px;border-bottom:1px solid var(--border);vertical-align:middle;}
    .village-table tr:last-child td{border-bottom:none;}
    .village-table tr:hover td{background:var(--bg3);}

    .rank-num{font-family:var(--mono);font-size:13px;color:var(--muted2);}
    .village-name{font-weight:600;color:var(--navy);font-size:14px;}
    .village-district{font-size:11px;color:var(--muted2);margin-top:2px;}

    .threat-tag{display:inline-block;padding:2px 7px;border-radius:2px;font-size:10px;font-weight:600;letter-spacing:.5px;font-family:var(--mono);}
    .threat-tag.both{background:rgba(26,39,68,0.08);color:var(--navy);}
    .threat-tag.glof{background:var(--green-dim);color:var(--green);}
    .threat-tag.flood{background:var(--orange-dim);color:var(--orange);}

    .rain-tag{display:inline-block;padding:2px 7px;border-radius:2px;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;font-family:var(--mono);}
    .rain-tag.high{background:var(--red-dim);color:var(--red);}
    .rain-tag.medium{background:var(--orange-dim);color:var(--orange);}
    .rain-tag.low{background:var(--green-dim);color:var(--green);}

    .road-val{font-size:12px;font-weight:500;}
    .road-val.safe{color:var(--green);}
    .road-val.blocked{color:var(--red);}

    .score-wrap{display:flex;align-items:center;gap:10px;}
    .score-bar-bg{width:60px;height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
    .score-bar-fill{height:100%;border-radius:2px;}
    .score-num{font-family:var(--mono);font-size:14px;font-weight:500;min-width:28px;}

    .priority-tag{display:inline-block;padding:3px 9px;border-radius:2px;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;font-family:var(--mono);}
    .priority-tag.high{background:var(--red-dim);color:var(--red);border:1px solid rgba(192,57,43,0.2);}
    .priority-tag.medium{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(211,84,0,0.2);}
    .priority-tag.low{background:var(--green-dim);color:var(--green);border:1px solid rgba(30,126,74,0.2);}

    .formula-card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:20px 24px;margin-top:16px;display:flex;align-items:center;gap:32px;flex-wrap:wrap;}
    .formula-label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px;}
    .formula-items{display:flex;gap:24px;flex-wrap:wrap;}
    .formula-item{text-align:center;}
    .formula-weight{font-family:var(--mono);font-size:18px;font-weight:500;color:var(--navy);line-height:1;margin-bottom:3px;}
    .formula-factor{font-size:11px;color:var(--muted2);}

    .fade-up{opacity:0;transform:translateY(8px);animation:fu .4s ease forwards;}
    @keyframes fu{to{opacity:1;transform:translateY(0);}}
    .d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}
  </style>
</head>
<body>

  <nav class="navbar">
    <a class="logo" href="index.html">
      <div class="logo-mark">‚òÇ</div>
      <div>
        <div class="logo-text">Umbrella</div>
        <div class="logo-sub">Disaster Intelligence ¬∑ Uttarakhand</div>
      </div>
    </a>
    <ul class="nav-links">
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="map.html">Risk Map</a></li>
      <li><a href="vulnerability.html" class="active">Vulnerability</a></li>
      <li><a href="resources.html">Resources</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
  </nav>

  <div class="page-header">
    <div>
      <div class="page-eyebrow">Live Scoring Engine ¬∑ Weighted Vulnerability Formula</div>
      <div class="page-title">Village Vulnerability Scorer</div>
      <div class="page-desc">Risk scores recalculated from live rainfall data on every page load</div>
    </div>
    <span class="status-badge" id="status-badge">‚è≥ Loading...</span>
  </div>

  <div class="stat-strip fade-up d1">
    <div class="stat-cell s-red">
      <div class="stat-label">Critical Villages</div>
      <div class="stat-value" id="stat-critical" style="color:var(--red)">‚Äî</div>
      <div class="stat-sub">Score ‚â• 70</div>
    </div>
    <div class="stat-cell s-orange">
      <div class="stat-label">Medium Risk</div>
      <div class="stat-value" id="stat-medium" style="color:var(--orange)">‚Äî</div>
      <div class="stat-sub">Score 45‚Äì69</div>
    </div>
    <div class="stat-cell s-green">
      <div class="stat-label">Watch Zone</div>
      <div class="stat-value" id="stat-watch" style="color:var(--green)">‚Äî</div>
      <div class="stat-sub">Score &lt; 45</div>
    </div>
    <div class="stat-cell s-navy">
      <div class="stat-label">Population at Risk</div>
      <div class="stat-value" id="stat-pop" style="font-size:22px;padding-top:4px;color:var(--navy)">‚Äî</div>
      <div class="stat-sub">High risk villages</div>
    </div>
  </div>

  <div class="content">
    <div class="filter-bar fade-up d2">
      <span class="filter-label">Filter:</span>
      <button class="filter-btn active-all" onclick="filterTable('all',this)">All Villages</button>
      <button class="filter-btn" onclick="filterTable('HIGH',this)">High Risk</button>
      <button class="filter-btn" onclick="filterTable('MEDIUM',this)">Medium Risk</button>
      <button class="filter-btn" onclick="filterTable('LOW',this)">Low Risk</button>
      <button class="filter-btn" onclick="filterTable('BOTH',this)">GLOF + Flood</button>
    </div>

    <div class="table-card fade-up d3">
      <div class="table-card-header">
        <span class="table-card-title" id="table-count">Loading villages...</span>
        <span style="font-family:var(--mono);font-size:10px;color:var(--muted2);">Scores from live Open-Meteo rainfall</span>
      </div>
      <table class="village-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Village</th>
            <th>Threat Type</th>
            <th>Population</th>
            <th>GLOF Travel</th>
            <th>Rainfall Risk</th>
            <th>Road Safe</th>
            <th>Score</th>
            <th>Priority</th>
          </tr>
        </thead>
        <tbody id="village-tbody">
          <tr><td colspan="9" style="text-align:center;color:var(--muted2);padding:32px;">Loading village data...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="formula-card fade-up d3">
      <div>
        <div class="formula-label">Scoring Formula</div>
        <div style="font-size:12px;color:var(--muted2);">Weighted across 5 factors ¬∑ Max score: 100</div>
      </div>
      <div class="formula-items">
        <div class="formula-item"><div class="formula-weight">25%</div><div class="formula-factor">Population</div></div>
        <div class="formula-item"><div class="formula-weight">20%</div><div class="formula-factor">GLOF Travel</div></div>
        <div class="formula-item"><div class="formula-weight">20%</div><div class="formula-factor">Rainfall</div></div>
        <div class="formula-item"><div class="formula-weight">20%</div><div class="formula-factor">Road Safety</div></div>
        <div class="formula-item"><div class="formula-weight">15%</div><div class="formula-factor">History</div></div>
      </div>
      <div style="margin-left:auto;text-align:right;">
        <div style="font-size:11px;color:var(--muted2);margin-bottom:4px;">Risk Classification</div>
        <div style="font-size:12px;color:var(--red);font-family:var(--mono);">‚â•70 HIGH</div>
        <div style="font-size:12px;color:var(--orange);font-family:var(--mono);">45‚Äì69 MEDIUM</div>
        <div style="font-size:12px;color:var(--green);font-family:var(--mono);">&lt;45 LOW</div>
      </div>
    </div>
  </div>

  <script>
    var BACKEND = "https://web-production-517aa.up.railway.app";
    var allVillages = [];

    fetch(BACKEND + "/villages")
      .then(function(r){return r.json();})
      .then(function(data){
        allVillages = data.villages;

        var badge = document.getElementById('status-badge');
        badge.className = 'status-badge live';
        badge.innerText = 'üü¢ Live ‚Äî ' + new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});

        var high   = allVillages.filter(function(v){return v.risk_level==='HIGH';});
        var medium = allVillages.filter(function(v){return v.risk_level==='MEDIUM';});
        var low    = allVillages.filter(function(v){return v.risk_level==='LOW';});
        var atRisk = high.reduce(function(s,v){return s+v.population;},0);

        document.getElementById('stat-critical').innerText = high.length;
        document.getElementById('stat-medium').innerText   = medium.length;
        document.getElementById('stat-watch').innerText    = low.length;
        document.getElementById('stat-pop').innerText      = atRisk.toLocaleString();

        renderTable(allVillages);
      })
      .catch(function(){
        document.getElementById('status-badge').innerText = 'üî¥ Server Offline';
        document.getElementById('village-tbody').innerHTML =
          '<tr><td colspan="9" style="text-align:center;color:var(--red);padding:32px;">‚ö† Backend offline</td></tr>';
      });

    function renderTable(villages){
      var sorted = villages.slice().sort(function(a,b){return b.score-a.score;});
      document.getElementById('table-count').innerText =
        sorted.length + ' village' + (sorted.length!==1?'s':'') + ' ‚Äî ranked by risk score';

      var html = '';
      sorted.forEach(function(v,i){
        var rc = v.risk_level==='HIGH'?'var(--red)':v.risk_level==='MEDIUM'?'var(--orange)':'var(--green)';
        var tc = v.threat_type==='BOTH'?'both':v.threat_type==='GLOF'?'glof':'flood';
        var tl = v.threat_type==='BOTH'?'GLOF + Flood':v.threat_type==='GLOF'?'GLOF':'Flood';
        var rainC = v.rainfall_risk==='HIGH'?'high':v.rainfall_risk==='MEDIUM'?'medium':'low';
        var travel = v.travel_time===999?'N/A':
          '<span style="color:'+(v.travel_time<=30?'var(--red)':v.travel_time<=60?'var(--orange)':'var(--green)')+'">'+v.travel_time+' min</span>';

        html +=
          '<tr data-risk="'+v.risk_level+'" data-threat="'+v.threat_type+'">' +
            '<td><span class="rank-num">'+(i+1)+'</span></td>' +
            '<td><div class="village-name">'+v.name+'</div><div class="village-district">'+v.district+'</div></td>' +
            '<td><span class="threat-tag '+tc+'">'+tl+'</span></td>' +
            '<td><span style="font-family:var(--mono);font-size:13px">'+v.population.toLocaleString()+'</span></td>' +
            '<td>'+travel+'</td>' +
            '<td><span class="rain-tag '+rainC+'">'+v.rainfall_risk+'</span></td>' +
            '<td><span class="road-val '+(v.road_safe?'safe':'blocked')+'">'+(v.road_safe?'‚úì Safe':'‚úó Blocked')+'</span></td>' +
            '<td><div class="score-wrap"><div class="score-bar-bg"><div class="score-bar-fill" style="width:'+v.score+'%;background:'+rc+'"></div></div><span class="score-num" style="color:'+rc+'">'+v.score+'</span></div></td>' +
            '<td><span class="priority-tag '+v.risk_level.toLowerCase()+'">'+v.risk_level+'</span></td>' +
          '</tr>';
      });

      document.getElementById('village-tbody').innerHTML = html;
    }

    function filterTable(type, btn){
      document.querySelectorAll('.filter-btn').forEach(function(b){b.className='filter-btn';});
      if(type==='all'){btn.className='filter-btn active-all';renderTable(allVillages);}
      else if(type==='HIGH'||type==='MEDIUM'||type==='LOW'){
        btn.className='filter-btn active-'+type.toLowerCase();
        renderTable(allVillages.filter(function(v){return v.risk_level===type;}));
      } else if(type==='BOTH'){
        btn.className='filter-btn active-both';
        renderTable(allVillages.filter(function(v){return v.threat_type==='BOTH';}));
      }
    }
  </script>

</body>
</html>
